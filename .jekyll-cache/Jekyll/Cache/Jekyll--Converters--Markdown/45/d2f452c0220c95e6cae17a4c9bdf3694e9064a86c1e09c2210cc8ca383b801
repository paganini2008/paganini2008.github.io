I"¶à<p><strong>chaconne</strong>ï¼ˆéŸ³è¯‘å¤ç©ºï¼‰ï¼Œæ˜¯ä¸€æ¬¾ç”¨Javaå†™çš„ï¼ŒåŸºäºSpringBootæ¡†æ¶çš„è½»é‡çº§çš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶ã€‚å¼•å…¥chaconneç›¸å…³ç»„ä»¶ï¼Œå¯ä»¥éå¸¸å¿«æ·åœ°å¸®åŠ©ä½ æ­å»ºä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡é›†ç¾¤</p>

<h3 id="chaconne-ç‰¹æ€§åˆ—è¡¨">chaconne ç‰¹æ€§åˆ—è¡¨</h3>
<hr />
<ol>
  <li>å®Œç¾æ”¯æŒspring-bootæ¡†æ¶ï¼ˆ2.2.0+ï¼‰</li>
  <li>æ”¯æŒå¤šç§æ–¹å¼è®¾ç½®çš„å®šæ—¶ä»»åŠ¡ï¼ˆCronè¡¨è¾¾å¼ï¼Œå‚æ•°è®¾ç½®ç­‰ï¼‰</li>
  <li>æ”¯æŒåŠ¨æ€ä¿å­˜å’Œåˆ é™¤ä»»åŠ¡</li>
  <li>æ”¯æŒæ³¨è§£é…ç½®å®šæ—¶ä»»åŠ¡</li>
  <li>æ”¯æŒä¸¤ç§é›†ç¾¤æ¨¡å¼ï¼ˆä¸»å¤‡æ¨¡å¼å’Œè´Ÿè½½å‡è¡¡æ¨¡å¼ï¼‰</li>
  <li>å†…ç½®å¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œæ”¯æŒè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç®—æ³•</li>
  <li>æ”¯æŒå¤±è´¥é‡è¯•å’Œå¤±è´¥è½¬ç§»</li>
  <li>æ”¯æŒæ—¥å¿—è¿½è¸ª</li>
  <li>æ”¯æŒä»»åŠ¡å‚æ•°åˆ†ç‰‡å¤„ç†</li>
  <li>æ”¯æŒä»»åŠ¡ä¾èµ–ï¼ˆä¸²è¡Œä¾èµ–å’Œå¹¶è¡Œä¾èµ–ï¼‰</li>
  <li>æ”¯æŒDAGæ¨¡æ‹Ÿå·¥ä½œæµ</li>
  <li>æ”¯æŒä»»åŠ¡è‡ªå®šä¹‰ç»ˆæ­¢ç­–ç•¥</li>
  <li>æ”¯æŒä»»åŠ¡è¶…æ—¶å†·å´å’Œé‡ç½®</li>
  <li>æ”¯æŒé‚®ä»¶å‘Šè­¦</li>
</ol>

<h3 id="chaconneä¸¤ç§é›†ç¾¤éƒ¨ç½²æ¨¡å¼">chaconneä¸¤ç§é›†ç¾¤éƒ¨ç½²æ¨¡å¼ï¼š</h3>
<hr />
<ol>
  <li>å»ä¸­å¿ƒåŒ–éƒ¨ç½²æ¨¡å¼
    <ul>
      <li>æ²¡æœ‰å›ºå®šçš„è°ƒåº¦ä¸­å¿ƒèŠ‚ç‚¹ï¼Œchaconneé›†ç¾¤ä¼šé€‰ä¸¾å…¶ä¸­ä¸€ä¸ªåº”ç”¨ä½œä¸ºLeader, è¿›è¡Œä»»åŠ¡æŒ‡æŒ¥è°ƒåº¦</li>
      <li>å‚ä¸è°ƒåº¦å’Œå‚ä¸æ‰§è¡Œçš„åº”ç”¨é€šè¿‡Tcpåè®®äº¤äº’</li>
    </ul>
  </li>
  <li>ä¸­å¿ƒåŒ–éƒ¨ç½²æ¨¡å¼
    <ul>
      <li>åˆ†ä¸ºè°ƒåº¦ä¸­å¿ƒå’Œä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹ä¸¤ä¸ªè§’è‰²ï¼Œä¸”è°ƒåº¦ä¸­å¿ƒå’Œä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹éƒ½æ”¯æŒé›†ç¾¤æ¨¡å¼</li>
      <li>è°ƒåº¦ä¸­å¿ƒå’Œä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹é€šè¿‡Httpåè®®äº¤äº’</li>
    </ul>
  </li>
</ol>

<p><strong>è¯´æ˜ï¼š</strong>
è¿™é‡Œçš„é›†ç¾¤æ˜¯æŒ‡å‚ä¸ä»»åŠ¡æ‰§è¡Œçš„åº”ç”¨æ‰€ç»„æˆçš„é›†ç¾¤(chaconneé›†ç¾¤)ï¼Œå®ƒå’ŒåŸºäºSpringCloudæ¡†æ¶ç»„æˆçš„é›†ç¾¤æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ¦‚å¿µ
å¦‚æœchaconneé›†ç¾¤è§„æ¨¡è¾ƒå°ï¼Œæ¨èä½¿ç”¨å»ä¸­å¿ƒåŒ–éƒ¨ç½²æ¨¡å¼ï¼Œè‹¥è¯¥é›†ç¾¤è§„æ¨¡è¾ƒå¤§ï¼Œä¾æ®å®é™…æƒ…å†µï¼Œä¸¤è€…æ¨¡å¼éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p>

<h3 id="chaconneæ¡†æ¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆ">chaconneæ¡†æ¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</h3>
<hr />
<ol>
  <li>chaconne-spring-boot-starter<br />
 æ ¸å¿ƒjaråŒ…ï¼ŒåŒ…å«äº†chaconneå…¨éƒ¨æ ¸å¿ƒåŠŸèƒ½ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰ä½ çš„Webç®¡ç†ç•Œé¢ï¼‰</li>
  <li>chaconne-console
 Chaconne Webç®¡ç†ç•Œé¢ï¼Œè¿›è¡Œä»»åŠ¡ç®¡ç†å’ŒæŸ¥çœ‹ä»»åŠ¡è¿è¡ŒçŠ¶æ€</li>
  <li>chaconne-manager
 å¦‚æœæ˜¯ä¸­å¿ƒåŒ–éƒ¨ç½²ï¼Œè¿™é‡Œæä¾›äº†ä¸ªchaconneçš„è°ƒåº¦ä¸­å¿ƒdemo</li>
</ol>

<h3 id="å®‰è£…">å®‰è£…ï¼š</h3>
<hr />
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	  <span class="nt">&lt;groupId&gt;</span>com.github.paganini2008.atlantis<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>chaconne-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>1.0-RC3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>
<p>ï¼ˆç¡®ä¿æ˜¯æœ€æ–°ç‰ˆï¼‰</p>

<h3 id="å…¼å®¹æ€§">å…¼å®¹æ€§ï¼š</h3>
<hr />
<ul>
  <li>Jdk 1.8 (or later)</li>
  <li>SpringBoot 2.2.0 (or later)</li>
  <li>Redis 3.0 (or later)</li>
  <li>MySQL 5.0 (or later)</li>
</ul>

<p><strong>è¯´æ˜ï¼š</strong>
Redisç”¨äºå­˜å–é›†ç¾¤ä¿¡æ¯å’Œåšæ¶ˆæ¯å¹¿æ’­
MySQLç”¨äºå­˜å–ä»»åŠ¡å®šä¹‰å’Œè¿è¡Œæ—¶ç›¸å…³æ•°æ®ï¼Œç›®å‰åªæ”¯æŒMySQL, å…³äºè¡¨ç»“æ„ï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨å»ºè¡¨</p>

<h3 id="å¿…è¦çš„é…ç½®">å¿…è¦çš„é…ç½®ï¼š</h3>
<hr />
<p>å¦‚æœæ˜¯ä¸­å¿ƒåŒ–é…ç½®ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.application.cluster.name</span><span class="p">=</span><span class="s">jobtester-cluster  # set chaconne cluster name</span>
<span class="py">spring.application.name</span><span class="p">=</span><span class="s">jobtester</span>

<span class="c">#Jdbc Configuration
</span><span class="py">atlantis.framework.chaconne.datasource.jdbcUrl</span><span class="p">=</span><span class="s">jdbc:mysql://localhost:3306/demo?userUnicode=true&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=UTF8&amp;useSSL=false&amp;autoReconnect=true&amp;zeroDateTimeBehavior=convertToNull</span>
<span class="py">atlantis.framework.chaconne.datasource.username</span><span class="p">=</span><span class="s">fengy</span>
<span class="py">atlantis.framework.chaconne.datasource.password</span><span class="p">=</span><span class="s">123456</span>
<span class="py">atlantis.framework.chaconne.datasource.driverClassName</span><span class="p">=</span><span class="s">com.mysql.cj.jdbc.Driver</span>

<span class="c">#Redis Configuration
</span><span class="py">atlantis.framework.redis.host</span><span class="p">=</span><span class="s">localhost</span>
<span class="py">atlantis.framework.redis.port</span><span class="p">=</span><span class="s">6379</span>
<span class="py">atlantis.framework.redis.password</span><span class="p">=</span><span class="s">123456</span>
<span class="py">atlantis.framework.redis.database</span><span class="p">=</span><span class="s">0</span>

<span class="py">spring.redis.messager.pubsub.channel</span><span class="p">=</span><span class="s">chaconne-management-messager-pubsub</span>
</code></pre></div></div>

<p>å¦‚æœæ˜¯å»ä¸­å¿ƒåŒ–é…ç½®ï¼Œåªè¦ç¡®ä¿æœ‰Redisé…ç½®å’ŒDataSourceé…ç½®å³å¯</p>

<h3 id="chaconneå®ç°åŸç†ç®€è¿°">chaconneå®ç°åŸç†ç®€è¿°</h3>
<hr />
<p>chaconneçš„åº•å±‚æ˜¯ä¾èµ–tridenter-spring-boot-starterç»„ä»¶æ¥å®ç°ä»»åŠ¡é›†ç¾¤æ¨¡å¼çš„ï¼ˆä¸»å¤‡æ¨¡å¼å’Œè´Ÿè½½å‡è¡¡æ¨¡å¼ï¼‰ï¼Œåˆ©ç”¨æ¶ˆæ¯å•æ’­æœºåˆ¶ï¼ˆé€šè¿‡Redis PubSubæ¨¡æ‹Ÿï¼‰æ¥å®ç°ä»»åŠ¡åˆ†å‘å’Œè´Ÿè½½å‡è¡¡ï¼Œåˆ†ç‰‡å¤„ç†ç­‰é«˜çº§ç‰¹æ€§ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œchaconneæ¡†æ¶ä¸­å…³äºé›†ç¾¤çš„å®šä¹‰å’Œtridenterå…³äºé›†ç¾¤çš„å®šä¹‰æ˜¯ä¸€è‡´çš„ï¼Œå¯¹äºé›†ç¾¤çš„æ¦‚å¿µï¼Œç­‰åŒäºç”¨æ¥åŒºåˆ«ä¸åŒçš„äº§å“ç»„æˆ–å…¬å¸ï¼ŒåŒæ—¶chaconneä¹Ÿæ”¯æŒä»»åŠ¡ç»„çš„æ¦‚å¿µï¼Œå®ƒæ˜¯å¯é€‰é…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç»„åå°±æ˜¯å½“å‰åº”ç”¨åç§°ï¼ˆ${spring.application.name}ï¼‰ï¼Œå³å½“èµ·äº†å¤šä¸ªç›¸åŒåº”ç”¨åçš„åº”ç”¨ï¼Œé‚£è¿™äº›åº”ç”¨å°±æˆä¸ºäº†ä¸€ä¸ªä»»åŠ¡ç»„ã€‚chaconneä¸ä»…æ”¯æŒè·¨ç»„çš„ä»»åŠ¡è°ƒç”¨ï¼Œæ›´æ”¯æŒè·¨é›†ç¾¤çš„ä»»åŠ¡è°ƒç”¨ã€‚</p>

<h3 id="å¦‚ä½•å®šä¹‰ä»»åŠ¡">å¦‚ä½•å®šä¹‰ä»»åŠ¡ï¼Ÿ</h3>
<hr />
<ol>
  <li>ä½¿ç”¨æ³¨è§£@ChacJob</li>
  <li>ç»§æ‰¿ManagedJobç±»</li>
  <li>å®ç°Jobæ¥å£</li>
  <li>å®ç°NotManagedJobæ¥å£
è¯´æ˜ï¼š
    <ul>
      <li>å‰3ç§å®šä¹‰ä»»åŠ¡çš„æ–¹å¼å±äºå£°æ˜å¼ï¼ˆç¼–ç¨‹å¼ï¼‰å®šä¹‰ä»»åŠ¡ï¼Œå³é€šè¿‡ä»£ç æ–¹å¼å®šä¹‰ä¸€ä¸ªä»»åŠ¡ï¼Œéšä¹‹Springæ¡†æ¶ä¸Šä¸‹æ–‡çš„å¯åŠ¨è€Œè‡ªåŠ¨åŠ è½½</li>
      <li>ç¬¬4ç§å®šä¹‰çš„æ–¹å¼ç”¨æ¥å®šä¹‰åŠ¨æ€ä»»åŠ¡ï¼Œç”¨æˆ·å¯ä»¥åœ¨Webç•Œé¢ä¸Šï¼ˆChaconne-Consoleï¼‰æäº¤æ¥åˆ›å»ºä»»åŠ¡æˆ–ç›´æ¥é€šè¿‡è°ƒç”¨Http API/SDKæ¥åˆ›å»ºä»»åŠ¡ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œé€šè¿‡è¯¥æ–¹å¼åˆ›å»ºçš„ä»»åŠ¡å¯¹è±¡ä¸å±äºSpringä¸Šä¸‹æ–‡æ‰˜ç®¡çš„Beanå¯¹è±¡ã€‚</li>
    </ul>
  </li>
</ol>

<p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong>
<strong>1. ç”¨æ³¨è§£æ–¹å¼åˆ›å»ºä»»åŠ¡</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ChacJob</span>
<span class="nd">@ChacTrigger</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">"*/5 * * * * ?"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoCronJob</span> <span class="o">{</span>

	<span class="nd">@Run</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">attachment</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoCronJob is running at: {}"</span><span class="o">,</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()));</span>
		<span class="k">return</span> <span class="nc">RandomUtils</span><span class="o">.</span><span class="na">randomLong</span><span class="o">(</span><span class="mi">1000000L</span><span class="o">,</span> <span class="mi">1000000000L</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnSuccess</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoCronJob's return value is: {}"</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnFailure</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"DemoCronJob is failed by cause: {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p><strong>2. æ¥å£æ–¹å¼åˆ›å»ºä»»åŠ¡</strong></p>
<ul>
  <li>
    <p>å®ç°Jobæ¥å£ï¼š
``` java
@Component
public class HelloWorldJob implements Job {</p>

    <p>@Override
  public String getClusterName() {
      return â€œyour_cluster_nameâ€;
  }</p>

    <p>@Override
  public String getGroupName() {
      return â€œyour_group_nameâ€;
  }</p>

    <p>@Override
  public int getRetries() {
      return 3;
  }</p>

    <p>@Override
  public long getTimeout() {
      return 60 * 1000L;
  }</p>

    <p>@Override
  public String getEmail() {
      return â€œyour_email@helloworld.comâ€;
  }</p>

    <p>@Override
  public Trigger getTrigger() {
      return GenericTrigger.Builder.newTrigger(1L, SchedulingUnit.MINUTES, false).build();
  }</p>

    <p>@Override
  public Object execute(JobKey jobKey, Object result, Logger logger) {
      return â€œHello World!â€;
  }</p>

    <p>@Override
  public void onSuccess(JobKey jobKey, Object result, Logger log) {
      if (log.isInfoEnabled()) {
          log.info(result.toString());
      }
  }</p>
  </li>
</ul>

<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* æˆ–ç»§æ‰¿ManagedJobç±»ï¼š
``` java
@Component
public class HealthCheckJob extends ManagedJob {

	@Override
	public long getTimeout() {
		return 60L * 1000;
	}

	@Override
	public Trigger getTrigger() {
		return GenericTrigger.Builder.newTrigger("*/5 * * * * ?").setStartDate(DateUtils.addSeconds(new Date(), 30)).build();
	}

	@Override
	public Object execute(JobKey jobKey, Object arg, Logger log) {
		if (log.isInfoEnabled()) {
			log.info(info());
		}
		return UUID.randomUUID().toString();
	}

	@Override
	public void onSuccess(JobKey jobKey, Object result, Logger log) {
		if (log.isInfoEnabled()) {
			log.info(result.toString());
		}
	}

	private String info() {
		long totalMemory = Runtime.getRuntime().totalMemory();
		long usedMemory = totalMemory - Runtime.getRuntime().freeMemory();
		return FileUtils.formatSize(usedMemory) + "/" + FileUtils.formatSize(totalMemory);
	}

}
</code></pre></div></div>
<p><strong>å¦‚ä½•åŠ¨æ€ä»»åŠ¡ï¼Ÿ</strong>
<strong>ç¬¬ä¸€ç§æ–¹å¼ï¼š</strong>åœ¨é¡µé¢ä¸Šåˆ›å»ºï¼ˆåé¢ä¼šè®²åˆ°ï¼‰
ç•¥
<strong>ç¬¬äºŒç§æ–¹å¼ï¼š</strong>é€šè¿‡SDKåˆ›å»º</p>
<ul>
  <li>
    <p>é¦–å…ˆå®ç°NotManagedJob æ¥å£å®šä¹‰ä»»åŠ¡
``` java
public class EtlJob implements NotManagedJob {</p>

    <p>@Override
  public Object execute(JobKey jobKey, Object attachment, Logger log) {
      log.info(â€œJobKey:{}, Parameter: {}â€, jobKey, attachment);
      return null;
  }</p>
  </li>
</ul>

<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ä½¿ç”¨Http APIè°ƒç”¨çš„æ–¹å¼
POST  http://localhost:6543/job/admin/persistJob
``` json
{
    "jobKey": {
        "clusterName": "yourCluster",
        "groupName": "yourGroup",
        "jobName": "yourJob",
        "jobClassName": "com.yourcompany.yourapp.YourJob"
    },
    "description": "Describe your job shortly",
    "email": "YourEmail@yourcompany.com",
    "retries": 0,
    "timeout": -1,
    "weight": 100,
    "dependentKeys": null,
    "forkKeys": null,
    "completionRate": -1,
    "trigger": {
        "triggerType": 1,
        "triggerDescription": {
            "cron": {
                "expression": "*/5 * * * * ?"
            }
        },
        "startDate": null,
        "endDate": null,
        "repeatCount": -1
    },
    "attachment": "{\"initialParameter\": \"test\"}"
}
</code></pre></div></div>
<ul>
  <li>
    <p>æˆ–è€…ä½¿ç”¨SDK:
``` java
@Component
public class TestService {</p>

    <p>@Autowired
  private JobManager jobManager;</p>

    <p>public void createJob() throws Exception {
      final JobKey jobKey = JobKey.by(â€œyourClusterâ€, â€œyourGroupâ€, â€œyourJobâ€, â€œcom.yourcompany.yourapp.YourJobâ€);
      GenericJobDefinition.Builder builder = GenericJobDefinition.newJob(jobKey)
              .setDescription(â€œDescribe your job shortlyâ€)
              .setEmail(â€œYourEmail@yourcompany.comâ€)
              .setRetries(3)
              .setTimeout(60000L);
      GenericTrigger.Builder triggerBuilder = GenericTrigger.Builder.newTrigger(â€œ*/5 * * * * ?â€);
      builder.setTrigger(triggerBuilder.build());
      GenericJobDefinition jobDefinition = builder.build();</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  jobManager.persistJob(jobDefinition, "{\"initialParameter\": \"test\"}");   }
</code></pre></div>    </div>
  </li>
</ul>

<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**æ³¨æ„ï¼š** ä»»åŠ¡åˆå§‹åŒ–å‚æ•°å»ºè®®æ˜¯jsonæ ¼å¼çš„

### ä»»åŠ¡ä¾èµ–
----------------------------
ä»»åŠ¡ä¾èµ–æ˜¯**chaconne**æ¡†æ¶çš„é‡è¦ç‰¹æ€§ä¹‹ä¸€ï¼Œä»»åŠ¡ä¾èµ–åˆ†ä¸º**ä¸²è¡Œä¾èµ–**å’Œ**å¹¶è¡Œä¾èµ–**ï¼Œ
æ‰€è°“ä¸²è¡Œä¾èµ–æ˜¯æŒ‡ä»»åŠ¡Aåšå®Œæ¥ç€æ‰§è¡Œä»»åŠ¡B,  å³ä»»åŠ¡Bä¾èµ–ä»»åŠ¡Aã€‚
å¹¶è¡Œä¾èµ–æ˜¯æŒ‡ï¼Œæ¯”å¦‚æœ‰3ä¸ªä»»åŠ¡ï¼Œåˆ†åˆ«ä¸ºä»»åŠ¡A, ä»»åŠ¡B, ä»»åŠ¡C, ä»»åŠ¡Aå’Œä»»åŠ¡Béƒ½åšå®Œæ‰èƒ½æ‰§è¡Œä»»åŠ¡C, ç±»ä¼¼ä¼šç­¾çš„ä¸šåŠ¡åœºæ™¯ã€‚
ä¸²è¡Œä¾èµ–å’Œå¹¶è¡Œä¾èµ–éƒ½å¯ä»¥å…±äº«ä»»åŠ¡ä¸Šä¸‹æ–‡å‚æ•°å’Œè¿è¡Œç»“æœï¼Œå¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰åˆ¤æ–­ç­–ç•¥æ¥å†³å®šè¦ä¸è¦è§¦å‘ä¸‹æ¸¸ä»»åŠ¡ã€‚
##### DAG(æœ‰å‘æ— ç¯å›¾)
è€Œåœ¨ç»“åˆä¸²è¡Œä¾èµ–å’Œå¹¶è¡Œä¾èµ–çš„åŸºç¡€ä¸Šï¼Œchaconneæ¡†æ¶åˆæä¾›äº†DAGåŠŸèƒ½å¹¶æä¾›äº†å‹å¥½çš„APIï¼Œæ¥æ¨¡æ‹Ÿç±»ä¼¼å·¥ä½œæµçš„ä¸šåŠ¡åœºæ™¯ï¼Œæ›´åŠ ä¸°å¯Œäº†ä»»åŠ¡ä¾èµ–çš„ä½¿ç”¨åœºæ™¯ã€‚
ï¼ˆè¿™é‡Œä¸ºäº†æ–¹ä¾¿ä¸¾ä¾‹ï¼Œéƒ½é€šè¿‡æ³¨è§£çš„æ–¹å¼é…ç½®ä»»åŠ¡)
##### ä¸²è¡Œä¾èµ–ç¤ºä¾‹ï¼š
``` java
@ChacJob
@ChacTrigger(triggerType = TriggerType.DEPENDENT)
@ChacDependency({ @ChacJobKey(className = "com.chinapex.test.chaconne.job.DemoSchedJob", name = "demoSchedJob") })
public class DemoDependentJob {

	@Run
	public Object execute(JobKey jobKey, Object attachment, Logger log) throws Exception {
		log.info("DemoDependentJob is running at: {}", DateUtils.format(System.currentTimeMillis()));
		return RandomUtils.randomLong(1000000L, 1000000000L);
	}

	@OnSuccess
	public void onSuccess(JobKey jobKey, Object result, Logger log) {
		log.info("DemoDependentJob's return value is: {}", result);
	}

	@OnFailure
	public void onFailure(JobKey jobKey, Throwable e, Logger log) {
		log.error("DemoDependentJob is failed by cause: {}", e.getMessage(), e);
	}

}
</code></pre></div></div>
<h5 id="å¹¶è¡Œä¾èµ–ç¤ºä¾‹">å¹¶è¡Œä¾èµ–ç¤ºä¾‹ï¼š</h5>
<p>æœ‰3ä¸ªä»»åŠ¡ï¼ŒDemoTask, DemoTaskOne, DemoTaskTwo
è®©DemoTaskOne, DemoTaskTwoéƒ½åšå®Œå†æ‰§è¡ŒDemoTaskï¼Œä¸”DemoTaskå¯ä»¥è·å¾—DemoTaskOne, DemoTaskTwoæ‰§è¡Œåçš„å€¼</p>
<h6 id="demotaskone">DemoTaskOne:</h6>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ChacJob</span>
<span class="nd">@ChacTrigger</span><span class="o">(</span><span class="n">triggerType</span> <span class="o">=</span> <span class="nc">TriggerType</span><span class="o">.</span><span class="na">SIMPLE</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoTaskOne</span> <span class="o">{</span>

	<span class="nd">@Run</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">attachment</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoTaskOne is running at: {}"</span><span class="o">,</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()));</span>
		<span class="k">return</span> <span class="nc">RandomUtils</span><span class="o">.</span><span class="na">randomLong</span><span class="o">(</span><span class="mi">1000000L</span><span class="o">,</span> <span class="mi">1000000000L</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnSuccess</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoTaskOne return value is: {}"</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnFailure</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"DemoTaskOne is failed by cause: {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<h6 id="demotasktwo">DemoTaskTwo:</h6>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ChacJob</span>
<span class="nd">@ChacTrigger</span><span class="o">(</span><span class="n">triggerType</span> <span class="o">=</span> <span class="nc">TriggerType</span><span class="o">.</span><span class="na">SIMPLE</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoTaskTwo</span> <span class="o">{</span>

	<span class="nd">@Run</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">attachment</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoTaskTwo is running at: {}"</span><span class="o">,</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()));</span>
		<span class="k">return</span> <span class="nc">RandomUtils</span><span class="o">.</span><span class="na">randomLong</span><span class="o">(</span><span class="mi">1000000L</span><span class="o">,</span> <span class="mi">1000000000L</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnSuccess</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoTaskTwo return value is: {}"</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnFailure</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"DemoTaskTwo is failed by cause: {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>
	
<span class="o">}</span>

</code></pre></div></div>
<h6 id="demotask">DemoTask:</h6>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ChacJob</span>
<span class="nd">@ChacTrigger</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">"0 0/1 * * * ?"</span><span class="o">,</span> <span class="n">triggerType</span> <span class="o">=</span> <span class="nc">TriggerType</span><span class="o">.</span><span class="na">CRON</span><span class="o">)</span>
<span class="nd">@ChacFork</span><span class="o">({</span> <span class="nd">@ChacJobKey</span><span class="o">(</span><span class="n">className</span> <span class="o">=</span> <span class="s">"com.chinapex.test.chaconne.job.DemoTaskOne"</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"demoTaskOne"</span><span class="o">),</span>
		<span class="nd">@ChacJobKey</span><span class="o">(</span><span class="n">className</span> <span class="o">=</span> <span class="s">"com.chinapex.test.chaconne.job.DemoTaskTwo"</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"demoTaskTwo"</span><span class="o">)</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoTask</span> <span class="o">{</span>

	<span class="nd">@Run</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">attachment</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoTask is running at: {}"</span><span class="o">,</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()));</span>
		<span class="nc">TaskJoinResult</span> <span class="n">joinResult</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TaskJoinResult</span><span class="o">)</span> <span class="n">attachment</span><span class="o">;</span>
		<span class="nc">TaskForkResult</span><span class="o">[]</span> <span class="n">forkResults</span> <span class="o">=</span> <span class="n">joinResult</span><span class="o">.</span><span class="na">getTaskForkResults</span><span class="o">();</span>
		<span class="kt">long</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">TaskForkResult</span> <span class="n">forkResult</span> <span class="o">:</span> <span class="n">forkResults</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">max</span><span class="o">,</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span> <span class="n">forkResult</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">max</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@OnSuccess</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"DemoTask return max value is: {}"</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@OnFailure</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Logger</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"DemoTask is failed by cause: {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<h5 id="dagä»»åŠ¡ç¤ºä¾‹">DAGä»»åŠ¡ç¤ºä¾‹</h5>
<p>DAGä»»åŠ¡ç›®å‰åªæ”¯æŒAPIåˆ›å»º, åç»­ä¼šæŒç»­æ”¹è¿›ï¼Œå¢åŠ ç•Œé¢æ–¹å¼åˆ›å»ºDAGä»»åŠ¡</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/dag"</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DagJobController</span> <span class="o">{</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.application.cluster.name}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">clusterName</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.application.name}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">applicationName</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">JobManager</span> <span class="n">jobManager</span><span class="o">;</span>

	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/create"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">createDagTask</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="nc">Dag</span> <span class="n">dag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Dag</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="n">applicationName</span><span class="o">,</span> <span class="s">"testDag"</span><span class="o">);</span><span class="c1">// åˆ›å»ºä¸€ä¸ªDagä»»åŠ¡ï¼Œå¹¶æŒ‡å®šé›†ç¾¤åï¼Œåº”ç”¨åï¼Œå’Œä»»åŠ¡åç§°</span>
		<span class="n">dag</span><span class="o">.</span><span class="na">setTrigger</span><span class="o">(</span><span class="k">new</span> <span class="nc">CronTrigger</span><span class="o">(</span><span class="s">"0 0/1 * * * ?"</span><span class="o">));</span><span class="c1">// è®¾ç½®Cronè¡¨è¾¾å¼</span>
		<span class="n">dag</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">"This is only a demo of dag job"</span><span class="o">);</span><span class="c1">// ä»»åŠ¡æè¿°</span>
		<span class="nc">DagFlow</span> <span class="n">first</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="na">startWith</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="n">applicationName</span><span class="o">,</span> <span class="s">"demoDagStart"</span><span class="o">,</span> <span class="nc">DemoDagStart</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span><span class="c1">// å®šä¹‰ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>
		<span class="nc">DagFlow</span> <span class="n">second</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">flow</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="n">applicationName</span><span class="o">,</span> <span class="s">"demoDag"</span><span class="o">,</span> <span class="nc">DemoDag</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span><span class="c1">// å®šä¹‰ç¬¬äºŒä¸ªèŠ‚ç‚¹</span>
                <span class="c1">// ç¬¬äºŒä¸ªèŠ‚ç‚¹forkä¸¤ä¸ªå­è¿›ç¨‹å¤„ç†</span>
		<span class="n">second</span><span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="n">applicationName</span><span class="o">,</span> <span class="s">"demoDagOne"</span><span class="o">,</span> <span class="nc">DemoDagOne</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="n">second</span><span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="n">applicationName</span><span class="o">,</span> <span class="s">"demoDagTwo"</span><span class="o">,</span> <span class="nc">DemoDagTwo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="n">jobManager</span><span class="o">.</span><span class="na">persistJob</span><span class="o">(</span><span class="n">dag</span><span class="o">,</span> <span class="s">"123"</span><span class="o">);</span>
		<span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"ok"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>ä¸Šé¢çš„DAGç¤ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œchaconneæ¡†æ¶æä¾›çš„DAGæ¨¡å‹æ”¯æŒä¸²è¡Œæµå…¥ï¼Œå³flowæ¨¡å¼ï¼Œä¹Ÿæä¾›äº†forkæ¨¡å¼è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œä¸Šä¾‹ä¸­ï¼Œä»»åŠ¡demoDag forkäº†ä¸¤ä¸ªå­è¿›ç¨‹ï¼ˆâ€œdemoDagOneâ€å’Œâ€œdemoDagTwoâ€ï¼‰ï¼Œå³demoDagOneå’ŒdemoDagTwoåŒæ—¶å¤„ç†å®Œäº†å†è§¦å‘demoDagä»»åŠ¡ã€‚</p>

<h3 id="chaconneéƒ¨ç½²è¯´æ˜">Chaconneéƒ¨ç½²è¯´æ˜</h3>
<hr />
<p>chaconneé™¤äº†ä¾æ‰˜SpringBootæ¡†æ¶å¤–ï¼Œé»˜è®¤ç”¨MySQLå­˜å‚¨ä»»åŠ¡ä¿¡æ¯(ç›®å‰ä»…æ”¯æŒMySQLï¼Œåç»­ä¼šæ”¯æŒæ›´å¤šç±»å‹çš„æ•°æ®åº“),  ç”¨Redisä¿å­˜é›†ç¾¤å…ƒæ•°æ®å’Œè¿›è¡Œæ¶ˆæ¯å¹¿æ’­ã€‚
æ‰€ä»¥æ— è®ºä½¿ç”¨å“ªç§éƒ¨ç½²æ–¹å¼ï¼Œä½ éƒ½éœ€è¦åœ¨ä½ çš„åº”ç”¨ä¸­è®¾ç½®DataSourceå’ŒRedisConnectionFactory
<strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceConfig</span> <span class="o">{</span>

	<span class="nd">@Setter</span>
	<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
	<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"spring.datasource"</span><span class="o">)</span>
        <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DataSourceConfig</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="nc">String</span> <span class="n">jdbcUrl</span><span class="o">;</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">driverClassName</span><span class="o">;</span>

		<span class="kd">private</span> <span class="nc">HikariConfig</span> <span class="nf">getDbConfig</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"DataSourceConfig JdbcUrl: "</span> <span class="o">+</span> <span class="n">jdbcUrl</span><span class="o">);</span>
				<span class="n">log</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"DataSourceConfig Username: "</span> <span class="o">+</span> <span class="n">username</span><span class="o">);</span>
				<span class="n">log</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"DataSourceConfig Password: "</span> <span class="o">+</span> <span class="n">password</span><span class="o">);</span>
				<span class="n">log</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"DataSourceConfig DriverClassName: "</span> <span class="o">+</span> <span class="n">driverClassName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="kd">final</span> <span class="nc">HikariConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariConfig</span><span class="o">();</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="n">driverClassName</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="n">jdbcUrl</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setMinimumIdle</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setMaximumPoolSize</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setMaxLifetime</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setIdleTimeout</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setValidationTimeout</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setConnectionInitSql</span><span class="o">(</span><span class="s">"SELECT UUID()"</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setConnectionTestQuery</span><span class="o">(</span><span class="s">"SELECT 1"</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">setTransactionIsolation</span><span class="o">(</span><span class="s">"TRANSACTION_READ_COMMITTED"</span><span class="o">);</span>

			<span class="n">config</span><span class="o">.</span><span class="na">addDataSourceProperty</span><span class="o">(</span><span class="s">"cachePrepStmts"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">addDataSourceProperty</span><span class="o">(</span><span class="s">"prepStmtCacheSize"</span><span class="o">,</span> <span class="s">"250"</span><span class="o">);</span>
			<span class="n">config</span><span class="o">.</span><span class="na">addDataSourceProperty</span><span class="o">(</span><span class="s">"prepStmtCacheSqlLimit"</span><span class="o">,</span> <span class="s">"2048"</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">config</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Primary</span>
		<span class="nd">@Bean</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">HikariDataSource</span><span class="o">(</span><span class="n">getDbConfig</span><span class="o">());</span>
		<span class="o">}</span>

	<span class="o">}</span>

	<span class="nd">@Setter</span>
	<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
	<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"spring.redis"</span><span class="o">)</span>
        <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="nc">String</span> <span class="n">host</span><span class="o">;</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
		<span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
		<span class="kd">private</span> <span class="kt">int</span> <span class="n">dbIndex</span><span class="o">;</span>

		<span class="nd">@Bean</span>
		<span class="kd">public</span> <span class="nc">RedisConnectionFactory</span> <span class="nf">redisConnectionFactory</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">RedisStandaloneConfiguration</span> <span class="n">redisStandaloneConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisStandaloneConfiguration</span><span class="o">();</span>
			<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setHostName</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
			<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
			<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setDatabase</span><span class="o">(</span><span class="n">dbIndex</span><span class="o">);</span>
			<span class="n">redisStandaloneConfiguration</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="nc">RedisPassword</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">password</span><span class="o">));</span>
			<span class="nc">JedisClientConfiguration</span><span class="o">.</span><span class="na">JedisClientConfigurationBuilder</span> <span class="n">jedisClientConfiguration</span> <span class="o">=</span> <span class="nc">JedisClientConfiguration</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
			<span class="n">jedisClientConfiguration</span><span class="o">.</span><span class="na">connectTimeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">60000</span><span class="o">)).</span><span class="na">readTimeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">60000</span><span class="o">)).</span><span class="na">usePooling</span><span class="o">()</span>
					<span class="o">.</span><span class="na">poolConfig</span><span class="o">(</span><span class="n">jedisPoolConfig</span><span class="o">());</span>
			<span class="nc">JedisConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisConnectionFactory</span><span class="o">(</span><span class="n">redisStandaloneConfiguration</span><span class="o">,</span> <span class="n">jedisClientConfiguration</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
			<span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span>
		<span class="kd">public</span> <span class="nc">JedisPoolConfig</span> <span class="nf">jedisPoolConfig</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">JedisPoolConfig</span> <span class="n">jedisPoolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisPoolConfig</span><span class="o">();</span>
			<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
			<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
			<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
			<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
			<span class="n">jedisPoolConfig</span><span class="o">.</span><span class="na">setTestWhileIdle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">jedisPoolConfig</span><span class="o">;</span>
		<span class="o">}</span>

	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰DataSourceå’ŒRedisConnectionFactory</p>

<h5 id="chaconneå»ä¸­å¿ƒåŒ–éƒ¨ç½²">Chaconneå»ä¸­å¿ƒåŒ–éƒ¨ç½²</h5>
<p>åœ¨ä½ çš„Springåº”ç”¨ç¨‹åºçš„ä¸»å‡½æ•°ä¸ŠåŠ ä¸Š@EnableChaconneEmbeddedModeæ³¨è§£ï¼Œç„¶åå¯åŠ¨
ç¤ºä¾‹ä»£ç ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableChaconneEmbeddedMode</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YourApplicationMain</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8088</span><span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"server.port"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">port</span><span class="o">));</span>
		<span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">YourApplicationMain</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<h5 id="chaconneä¸­å¿ƒåŒ–éƒ¨ç½²">Chaconneä¸­å¿ƒåŒ–éƒ¨ç½²</h5>
<ul>
  <li>å¯åŠ¨è°ƒåº¦ä¸­å¿ƒï¼Œè¿™éœ€è¦ä½ æ–°å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œåœ¨ä¸»å‡½æ•°ä¸ŠåŠ ä¸Š@EnableChaconneDetachedModeæ³¨è§£ï¼Œå¹¶æŒ‡å®šä¸ºç”Ÿäº§ç«¯
ç¤ºä¾‹ä»£ç ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableChaconneDetachedMode</span><span class="o">(</span><span class="nc">DetachedMode</span><span class="o">.</span><span class="na">PRODUCER</span><span class="o">)</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChaconneManagementMain</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">ChaconneManagementMain</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>ï¼ˆåŒæ—¶éœ€è¦é…ç½®DataSourceå’ŒRedisConnectionFactoryï¼‰</p>
  </li>
  <li>æˆ–è€…ç›´æ¥ä½¿ç”¨æ³¨è§£@ChaconneAdminå³å¯ï¼Œç¤ºä¾‹ä»£ç ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ChaconneAdmin</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChaconneManagerApplication</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"spring.devtools.restart.enabled"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>
      <span class="nc">File</span> <span class="n">logDir</span> <span class="o">=</span> <span class="nc">FileUtils</span><span class="o">.</span><span class="na">getFile</span><span class="o">(</span><span class="nc">FileUtils</span><span class="o">.</span><span class="na">getUserDirectory</span><span class="o">(),</span> <span class="s">"logs"</span><span class="o">,</span> <span class="s">"indi"</span><span class="o">,</span> <span class="s">"atlantis"</span><span class="o">,</span> <span class="s">"framework"</span><span class="o">,</span> <span class="s">"chaconne"</span><span class="o">,</span> <span class="s">"management"</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">logDir</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">logDir</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"LOG_BASE"</span><span class="o">,</span> <span class="n">logDir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">ChaconneManagerApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Env</span><span class="o">.</span><span class="na">getPid</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li>
    <p>åœ¨ä½ çš„Springåº”ç”¨ç¨‹åºçš„ä¸»å‡½æ•°ä¸ŠåŠ ä¸Š@EnableChaconneDetachedModeæ³¨è§£ï¼ˆé»˜è®¤ä¸ºæ¶ˆè´¹ç«¯ï¼‰ï¼Œç„¶åå¯åŠ¨
``` java
@EnableChaconneDetachedMode
@SpringBootApplication
@ComponentScan
public class YourApplicationMain {</p>

    <p>public static void main(String[] args) {
     final int port = 8088;
     System.setProperty(â€œserver.portâ€, String.valueOf(port));
     SpringApplication.run(YourApplicationMain.class, args);
 }</p>
  </li>
</ol>

<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Chaconne Consoleä½¿ç”¨è¯´æ˜
-----------------------------------
Chaconne Consoleæ˜¯**chaconne**æ¡†æ¶æä¾›çš„ä»»åŠ¡ç®¡ç†å’ŒæŸ¥çœ‹çš„Webé¡¹ç›®ï¼Œå®ƒä¹Ÿæ”¯æŒå»ä¸­å¿ƒåŒ–éƒ¨ç½²å’Œä¸­å¿ƒåŒ–éƒ¨ç½²æ¨¡å¼ï¼Œé»˜è®¤ç«¯å£6140
æä¾›äº†å¦‚ä¸‹åŠŸèƒ½ï¼š
1. ä¿å­˜ä»»åŠ¡å’ŒæŸ¥çœ‹ä»»åŠ¡ä¿¡æ¯
2. æš‚åœå’Œç»§ç»­ä»»åŠ¡
3. åˆ é™¤ä»»åŠ¡
4. æ‰‹åŠ¨è¿è¡Œä»»åŠ¡
5. æŸ¥çœ‹ä»»åŠ¡ç»Ÿè®¡ï¼ˆæŒ‰å¤©ï¼‰
6. æŸ¥çœ‹ä»»åŠ¡è¿è¡Œæ—¶æ—¥å¿—

ç›®å‰Chaconne Consoleé¡¹ç›®è¿˜åœ¨ä¸æ–­çš„ç»´æŠ¤ä¸­ï¼Œæœ‰äº›åŠŸèƒ½ç•¥æ˜¾ç²—ç³™ï¼ˆä»»åŠ¡JSONç¼–è¾‘å™¨ï¼‰ï¼Œæœ‰äº›åŠŸèƒ½æš‚æœªå¼€æ”¾ã€‚
åŒæ ·ï¼ŒChaconne Consoleä¹Ÿæ˜¯ä¸€ä¸ªSpringBootçš„å·¥ç¨‹
æºç ï¼š
``` java
@EnableChaconneClientMode
@SpringBootApplication(exclude = { DataSourceAutoConfiguration.class })
public class ChaconneConsoleMain {

	static {
		System.setProperty("spring.devtools.restart.enabled", "false");
		File logDir = FileUtils.getFile(FileUtils.getUserDirectory(), "logs", "indi", "atlantis", "framework", "chaconne", "console");
		if (!logDir.exists()) {
			logDir.mkdirs();
		}
		System.setProperty("DEFAULT_LOG_BASE", logDir.getAbsolutePath());
	}

	public static void main(String[] args) {
		SpringApplication.run(ChaconneConsoleMain.class, args);
		System.out.println(Env.getPid());
	}

}
</code></pre></div></div>
<p>æ³¨è§£@EnableChaconneClientModeè¡¨ç¤ºå¯ç”¨ä¸€ä¸ªä»»åŠ¡ç®¡ç†å®¢æˆ·ç«¯
å¯åŠ¨åï¼Œè¾“å…¥é¦–é¡µåœ°å€ï¼šhttp://localhost:6140/chaconne/index
<strong>é¦–å…ˆè¿›å…¥çš„overviewé¡µé¢:</strong>
<img src="https://upload-images.jianshu.io/upload_images/26217505-24e16386c32483c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p><strong>ä»»åŠ¡åˆ—è¡¨ï¼š</strong>
<img src="https://upload-images.jianshu.io/upload_images/26217505-9e9284d981e924ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p><strong>åˆ›å»ºä»»åŠ¡ï¼š</strong>
<img src="https://upload-images.jianshu.io/upload_images/26217505-7fb05512f9eb38b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p>ç‚¹å‡»ShowJsonå¯ä»¥å±•ç¤ºJsonæ ¼å¼çš„æ•°æ®ï¼š
<img src="https://upload-images.jianshu.io/upload_images/26217505-22915828fc6d8666.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p><strong>ä»»åŠ¡è¯¦æƒ…ï¼š</strong>
<img src="https://upload-images.jianshu.io/upload_images/26217505-fc40433bb28e0044.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p><strong>ä»»åŠ¡æ—¥å¿—ï¼š</strong>
<img src="https://upload-images.jianshu.io/upload_images/26217505-2403eb9291183071.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p><strong>ä»»åŠ¡ç»Ÿè®¡ï¼š</strong>
<img src="https://upload-images.jianshu.io/upload_images/26217505-53ac71febc3b8b97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" />
å¯æŸ¥çœ‹æ¯ä¸€ä¸ªä»»åŠ¡çš„ç»Ÿè®¡ï¼ˆæŒ‰å¤©ï¼‰
<img src="https://upload-images.jianshu.io/upload_images/26217505-99d131f3cc9d4920.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<p>æœ€åï¼Œé™„ä¸Šåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿchaconneçš„æºç åœ°å€ï¼šhttps://github.com/paganini2008/chaconne.git
æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥ç ”ç©¶ä¸€ä¸‹å®ƒçš„æºç </p>
:ET